<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ekolojik Kelime Oyunu - Online Multiplayer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: url('https://images.adsttc.com/media/images/66d5/3ffe/d393/f151/0923/af16/slideshow/urban-regeneration-4-projects-harnessing-water-to-reconnect-cities-with-nature_1.jpg?1725251594') no-repeat center center fixed;
      background-size: cover;
      margin: 0;
      padding: 20px;
      color: #000;
    }
    #logo {
      position: fixed;
      top: 10px;
      right: 120px;
      height: 150px;
    }
    #timer {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 24px;
      color: white;
      background-color: rgba(0, 0, 0, 0.5);
      padding: 5px 10px;
      border-radius: 5px;
    }
    button {
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 15px;
      cursor: pointer;
      font-size: 16px;
      transition: background-color 0.3s ease;
      margin: 5px;
    }
    button:hover {
      background-color: #45a049;
    }
    button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }
    #gameArea, #playerInfo, #questionArea, #scoreboard {
      margin-top: 20px;
      background-color: rgba(255, 255, 255, 0.9);
      padding: 15px;
      border-radius: 8px;
      color: #000;
    }
    #startScreen {
      background-color: rgba(255, 255, 255, 0.95);
      padding: 15px;
      border-radius: 8px;
      max-width: 400px;
      margin: auto;
      color: #000;
      text-align: center;
    }
    input[type="text"], input[type="number"] {
      border: none;
      border-bottom: 2px solid #000;
      font-size: 18px;
      letter-spacing: 1px;
      background: transparent;
      text-align: center;
      width: 80%;
      padding: 5px;
      color: #000;
    }
    input:disabled {
        background-color: #f2f2f2;
    }
    #bottomLogo {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      height: 100px;
    }
  </style>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

</head>
<body>

  <img src="images/logo.png" alt="Logo" id="logo" />

  <h1>Ekolojik Kelime Oyunu - Online Multiplayer</h1>
  <div id="timer">3:00</div>

  <div id="startScreen">
    <label for="playerNameInput">İsminiz:</label><br />
    <input type="text" id="playerNameInput" placeholder="İsminizi girin" /><br /><br />

    <label for="playerCountInput">Oyuncu Sayısı (1-5):</label><br />
    <input type="number" id="playerCountInput" min="1" max="5" value="2" /><br /><br />

    <label for="roomCodeInput">Oda Kodu (varsa):</label><br />
    <input type="text" id="roomCodeInput" placeholder="Oda kodu gir veya boş bırak" maxlength="6" /><br /><br />

    <button id="btnStart">Odaya Katıl / Kur</button>
  </div>

  <div id="gameArea" style="display:none;">
    <div id="playerInfo"></div>
    <div id="questionArea"></div>
    <div id="scoreboard"></div>
  </div>

  <footer>
    <img src="images/altlogo.png" alt="Alt Logo" id="bottomLogo" />
  </footer>

  <script>
    // Firebase konfigürasyonu
    const firebaseConfig = {
      apiKey: "AIzaSyAuFzlMGvI2jKgxiGSbkWHeI5_xzue24iU",
      authDomain: "ekokelime.firebaseapp.com",
      databaseURL: "https://ekokelime-default-rtdb.firebaseio.com",
      projectId: "ekokelime",
      storageBucket: "ekokelime.firebasestorage.app",
      messagingSenderId: "691968985782",
      appId: "1:691968985782:web:e824a4dc2486c1830d7417"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Oyun değişkenleri
    let playerName = "";
    let playerCount = 2;
    let roomCode = "";
    let currentPlayerIndex = 0;
    let players = [];
    let questionsList = [];
    let currentQuestionIndex = 0;
    let scores = [];
    let timerInterval = null;
    let timeRemaining = 180; // Her oyuncu için 3 dakika
    let revealedLetters = [];
    let currentAnswer = "";

    // Kelimeler ve tanımlar
    const kelimeler = {
      4: {
        "Atık": "Kullanım sonrası geriye kalan maddeler",
        "Azot": "Atmosferde en yüksek yüzdeyle bulunan gaz",
        "Hava": "Sonrasına cıva getirilerek konuşulan konunun boş olduğunu belirten kelime",
        "Ağaç": "Orman dokusu",
        "Otsu": "Ot gibi olan",
        "Kent": "Şehir",
        "Park": "Vatandaşların dinlenme ve oyun ihtiyaçlarını karşılayan alan",
        "Plan": "Belirlenen hedefe ulaşmak için oluşturulan strateji ve yol haritası",
        "Oyun": "Eğlence amacıyla yapılan etkinlik",
        "Dere": "Küçük, doğal su yolu"
      },
      5: {
        "Çevre": "Canlıların yaşadığı ve etkileşimde bulunduğu doğal veya insan yapımı ortam",
        "İklim": "Uzun süreli hava koşulları ortalaması",
        "Liken": "Mantar ve fotosentetik organizmanın simbiyotik ilişkisi",
        "Flora": "Bir bölgede bulunan bitki türlerinin toplamı",
        "Fauna": "Bir bölgede bulunan hayvan türlerinin toplamı",
        "Deniz": "Karaları çevreleyen geniş su kütlesi",
        "Bahçe": "Bitki yetiştirmeye ve dinlenmeye uygun düzenlenmiş yeşil alan",
        "Yeşil": "Bir renk",
        "Yaban": "Vahşi, doğal",
        "Yunus": "Sosyal ve zeki memeli"
      },
      6: {
        "Rüzgar": "Havanın hareketiyle oluşan doğal akım",
        "Toprak": "Bitkilerin yetiştiği ve canlıların barındığı doğal zemin",
        "Peyzaj": "Fransızca kır manzarası",
        "Enerji": "Hareketi meydana getiren temel güç",
        "Deprem": "Yer kabuğunun sarsılması",
        "YAYSİS": "Yeşil alan yönetim sistemi kısaltması",
        "Paydaş": "Bir projenin etkilenen birey veya grubu",
        "Direnç": "Dış etkilere karşı gösterilen tepki",
        "Heykel": "Taş, metal veya ahşaptan yapılan sanat eseri",
        "Takson": "Canlıların gruplandırılma birimi"
      },
      7: {
        "Ekoloji": "Canlıların çevreleriyle ilişkisini inceleyen bilim",
        "Dönüşüm": "Kafka'nın bilinen eseri",
        "Tasarım": "Estetik ve işlevsel planlama süreci",
        "Habitat": "Canlıların doğal yaşam alanı",
        "Erozyon": "Toprağın su veya rüzgarla aşınıp taşınması",
        "Organik": "Sentetik olmayan",
        "Ekosfer": "Tüm ekosistemleri kapsayan kavram",
        "Biyolog": "Canlıları inceleyen bilim insanı",
        "Kreatif": "Yaratıcı düşünce yeteneği",
        "Kuşgöçü": "Kanatlı hayvan hicreti"
      },
      8: {
        "Kurakçıl": "Az su isteyen",
        "Strateji": "Belirli hedefe ulaşma planı",
        "Kirlilik": "İstenmeyen maddelerin varlığı",
        "İstanbul": "Metropol",
        "Ekolojik": "Çevre bilimiyle ilgili",
        "Çalıştay": "Belli bir konuda, çeşitli konuşmacıların katılımıyla düzenlenen, bilimsel ağırlıklı toplantı",
        "Atmosfer": "Hava tabakası",
        "Biyoloji": "Canlıları ve yaşam süreçlerini inceleyen bilim dalı",
        "Mühendis": "Arapça hendese kelimesinden türeyen kelime; ölçüm yapan, hesaplayan",
        "Anıtağaç": "Yaşı, tarihi veya doğal özellikleriyle koruma altına alınmış olan"
      },
      9: {
        "Ekosistem": "Canlılar ve çevre arasındaki etkileşim",
        "Kütüphane": "Bilgi kaynaklarının saklandığı ve okuyuculara sunulduğu yer",
        "Büyükdere": "Atatürk’ün mirası",
        "İnovasyon": "Yeni fikir ve ürün geliştirme süreci",
        "Sulakalan": "Bitki ve hayvan çeşitliliği açısından zengin, nemli ve verimli ekosistemlerdir",
        "Yeşilçatı": "Çevre dostu yapı tasarımı",
        "Amenajman": "Ormanların sürdürülebilir kullanımı ve verimli yönetimi için planlama yapan ormancılık alanı",
        "Departman": "Kuruluş içi bölüm",
        "Herbaryum": "Kurutulmuş bitki koleksiyonu",
        "Sıfıratık": "Hammadelerin dönüşümü üzerine kurulan sistem"
      },
      10: {
        "Rekreasyon": "Boş zaman aktiviteleri",
        "Doğalçevre": "Yapılı olmayan, müdahale görmemiş",
        "Fotosentez": "Bitkilerin güneş enerjisiyle besin üretme süreci",
        "Adaptasyon": "Canlıların yaşadıkları çevreye uyum sağlamak için geliştirdiği kalıtsal veya fizyolojik özellikler",
        "Kentormanı": "Kentsel ekosistemin parçası olan, yeşil doku ve biyoçeşitliliği barındıran alanlar",
        "Korumazonu": "Ekosistemleri ve biyolojik çeşitliliği korumak amacıyla belirlenen özel alan",
        "Vejetasyon": "Doğal bitki örtüsü",
        "Likenoloji": "Mantar ve algların incelenmesi",
        "Yeşilkuşak": "Şehirleri çevreleyen, ekolojik dengeyi koruyan ağaçlık ve doğal alanlar",
        "Büyükşehir": "Gelişmiş sosyal ve altyapılı şehir"
      }
    };

    // Puan tablosu (kelime uzunluğuna göre)
    const points = {
      4: 400,
      5: 500,
      6: 600,
      7: 700,
      8: 800,
      9: 900,
      10: 1000,
    };

    // Rastgele oda kodu üret
    function generateRoomCode() {
      return Math.random().toString(36).substring(2, 8).toUpperCase();
    }
    
    // Soruları harf sayısına göre (2x4, 2x5, ...) sıralı üreten fonksiyon
    function generateStructuredTurnQuestions() {
        const structuredQuestions = [];
        for (let len = 4; len <= 10; len++) {
            const wordsOfLength = Object.keys(kelimeler[len] || {});
            // Kelimeleri karıştır ve ilk ikisini al
            const shuffledWords = wordsOfLength.sort(() => 0.5 - Math.random());
            const selectedWords = shuffledWords.slice(0, 2);
            
            for (const word of selectedWords) {
                structuredQuestions.push({
                    wordLength: len,
                    word: word,
                    definition: kelimeler[len][word]
                });
            }
        }
        return structuredQuestions; // Toplam 14 soruluk sıralı liste
    }


    // Başlat butonu
    document.getElementById("btnStart").onclick = async () => {
      playerName = document.getElementById("playerNameInput").value.trim();
      if (!playerName) {
        alert("Lütfen isminizi girin!");
        return;
      }
      playerCount = parseInt(document.getElementById("playerCountInput").value);
      if (playerCount < 1 || playerCount > 5) {
        alert("Oyuncu sayısı 1 ile 5 arasında olmalıdır.");
        return;
      }
      let enteredCode = document.getElementById("roomCodeInput").value.trim().toUpperCase();

      if (enteredCode) {
        const roomSnap = await db.ref(`rooms/${enteredCode}`).get();
        if (!roomSnap.exists()) {
          alert("Oda bulunamadı.");
          return;
        }
        roomCode = enteredCode;
        const roomData = roomSnap.val();
        if (roomData.players && Object.keys(roomData.players).length >= roomData.playerCount) {
          alert("Oda dolu.");
          return;
        }
        await joinRoom(roomCode);
      } else {
        roomCode = generateRoomCode();
        await createRoom(roomCode);
      }
    };

    // Oda oluştur
    async function createRoom(code) {
      players = [playerName];
      scores = [0];
      currentPlayerIndex = 0;
      currentQuestionIndex = 0;
      
      questionsList = generateStructuredTurnQuestions();

      await db.ref(`rooms/${code}`).set({
        players,
        playerCount,
        currentPlayerIndex,
        currentQuestionIndex,
        scores,
        questionsList,
        revealedLetters: [],
        turnStartTime: firebase.database.ServerValue.TIMESTAMP
      });
      alert(`Oda kuruldu. Kodu diğer oyunculara verin: ${code}`);
      startGame();
    }

    // Odaya katıl
    async function joinRoom(code) {
      const roomRef = db.ref(`rooms/${code}`);
      const roomSnap = await roomRef.get();
      const roomData = roomSnap.val();

      players = roomData.players || [];
      scores = roomData.scores || [];
      
      if (!players.includes(playerName)) {
        players.push(playerName);
        scores.push(0);
        await roomRef.update({ players, scores });
      }
      
      alert(`Odaya katıldınız: ${code}`);
      startGame();
    }

    // Oyun başlat
    function startGame() {
      document.getElementById("startScreen").style.display = "none";
      document.getElementById("gameArea").style.display = "block";
      listenRoom();
    }

    // Firebase dinleme
    function listenRoom() {
      db.ref(`rooms/${roomCode}`).on("value", (snapshot) => {
        const data = snapshot.val();
        if (!data) return;

        players = data.players || players;
        scores = data.scores || scores;
        
        const previousPlayerIndex = currentPlayerIndex;
        currentPlayerIndex = data.currentPlayerIndex ?? currentPlayerIndex;
        
        currentQuestionIndex = data.currentQuestionIndex ?? currentQuestionIndex;
        questionsList = data.questionsList || [];
        revealedLetters = data.revealedLetters || [];

        updatePlayerInfo();
        updateScoreboard();
        
        if (previousPlayerIndex !== currentPlayerIndex || !timerInterval) {
             startTimer(data.turnStartTime);
        }

        showQuestion(); 
      });
    }

    // Oyuncu bilgisi
    function updatePlayerInfo() {
      let html = `<h2>Oyuncular:</h2><ul>`;
      players.forEach((p, i) => {
        html += `<li>${p} - ${scores[i] || 0} Puan ${i === currentPlayerIndex ? "<strong>(Sıra sende)</strong>" : ""}</li>`;
      });
      html += "</ul>";
      document.getElementById("playerInfo").innerHTML = html;
    }

    // Skor panosu
    function updateScoreboard() {
      let html = `<h2>Skorlar:</h2><ul>`;
      players.forEach((p, i) => {
        html += `<li>${p}: ${scores[i] || 0} Puan</li>`;
      });
      html += "</ul>";
      document.getElementById("scoreboard").innerHTML = html;
    }

    // Soru göster
    function showQuestion() {
      const isMyTurn = players[currentPlayerIndex] === playerName;

      if (!questionsList || questionsList.length === 0) {
        document.getElementById("questionArea").innerHTML = `<h3>Sorular yükleniyor...</h3>`;
        return;
      }
      
      if (currentQuestionIndex >= questionsList.length) {
        if(isMyTurn) {
            nextPlayerTurn();
        } else {
             document.getElementById("questionArea").innerHTML = `<h3>${players[currentPlayerIndex]} sırasını tamamladı. Yeni oyuncu başlıyor...</h3>`;
        }
        return;
      }
      
      if (players.length < playerCount) {
        document.getElementById("questionArea").innerHTML = `<h3>Diğer oyuncular bekleniyor (${players.length}/${playerCount})... Oda Kodu: ${roomCode}</h3>`;
        return;
      }

      const q = questionsList[currentQuestionIndex];
      currentAnswer = q.word;

      let placeholderStr = "";
      for (let i = 0; i < currentAnswer.length; i++) {
        placeholderStr += revealedLetters[i] ? currentAnswer[i] + " " : "_ ";
      }

      document.getElementById("questionArea").innerHTML = `
        <h3>Sıradaki Oyuncu: ${players[currentPlayerIndex]}</h3>
        <p><b>Soru ${currentQuestionIndex + 1}/14 (${q.wordLength} Harfli)</b></p>
        <p><i>${q.definition}</i></p>
        <h2>${placeholderStr.trim()}</h2>
        <input type="text" id="answerInput" placeholder="Tahmininizi yazın" autocomplete="off" ${!isMyTurn ? 'disabled' : ''} />
        <button id="btnSubmitAnswer" ${!isMyTurn ? 'disabled' : ''}>Gönder</button>
        <button id="btnRevealLetter" ${!isMyTurn ? 'disabled' : ''}>Harf Aç (-100 Puan)</button>
      `;

      if (isMyTurn) {
        document.getElementById("answerInput").focus();
        document.getElementById("btnSubmitAnswer").onclick = submitAnswer;
        document.getElementById("btnRevealLetter").onclick = revealLetter;
      }
    }

    // Harf aç
    function revealLetter() {
      scores[currentPlayerIndex] -= 100;

      let unrevealedIndexes = [];
      for(let i=0; i < currentAnswer.length; i++){
          if(!revealedLetters[i]) unrevealedIndexes.push(i);
      }
      
      if(unrevealedIndexes.length > 0){
        const randomIndex = unrevealedIndexes[Math.floor(Math.random() * unrevealedIndexes.length)];
        revealedLetters[randomIndex] = true;

        db.ref(`rooms/${roomCode}`).update({ revealedLetters, scores });
      }
    }

    // Cevap gönder
    function submitAnswer() {
      let guess = document.getElementById("answerInput").value.trim();
      if (!guess) return;

      if (guess.toUpperCase() === currentAnswer.toUpperCase()) {
        scores[currentPlayerIndex] += points[currentAnswer.length] || 0;
        currentQuestionIndex++;
        revealedLetters = []; // Sonraki soru için temizle
        db.ref(`rooms/${roomCode}`).update({
          scores,
          currentQuestionIndex,
          revealedLetters,
        });
      } else {
        alert("Yanlış cevap!");
        scores[currentPlayerIndex] -= 200; // Yanlış cevap cezası
        db.ref(`rooms/${roomCode}`).update({ scores });
      }
    }

    // Sıradaki oyuncuya geç
    async function nextPlayerTurn() {
      stopTimer();
      currentPlayerIndex++;
      
      if (currentPlayerIndex >= players.length) {
        endGame();
        return;
      }

      const newQuestions = generateStructuredTurnQuestions();
      
      await db.ref(`rooms/${roomCode}`).update({
        currentPlayerIndex,
        currentQuestionIndex: 0,
        revealedLetters: [],
        questionsList: newQuestions,
        turnStartTime: firebase.database.ServerValue.TIMESTAMP
      });
    }

    // Oyun sonu
    function endGame() {
      stopTimer();
      let maxScore = -Infinity;
      scores.forEach(score => {
          if(score > maxScore) maxScore = score;
      });
      
      let winners = players.filter((p, i) => scores[i] === maxScore);

      document.getElementById("questionArea").innerHTML = `
        <h2>Oyun Bitti!</h2>
        <h3>Kazanan(lar): ${winners.join(", ")}</h3>
        <h4>Puan: ${maxScore}</h4>
      `;
       db.ref(`rooms/${roomCode}`).off();
       db.ref(`rooms/${roomCode}`).remove();
    }

    // Timer
    function startTimer(turnStartTime) {
      stopTimer();
      timerInterval = setInterval(() => {
        let elapsed = Math.floor((Date.now() - turnStartTime) / 1000);
        timeRemaining = 180 - elapsed;

        if (timeRemaining <= 0) {
          timeRemaining = 0;
          updateTimerDisplay();
          stopTimer();
          
          if (players[currentPlayerIndex] === playerName) {
            alert("Süreniz doldu!");
            nextPlayerTurn();
          }
        } else {
          updateTimerDisplay();
        }
      }, 1000);
    }

    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }

    function updateTimerDisplay() {
      let m = Math.floor(timeRemaining / 60);
      let s = timeRemaining % 60;
      document.getElementById("timer").textContent = `${m}:${s < 10 ? "0" + s : s}`;
    }
  </script>
</body>
</html>
