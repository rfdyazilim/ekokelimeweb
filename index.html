<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ekolojik Kelime Oyunu - Stabil Versiyon</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: url('https://images.adsttc.com/media/images/66d5/3ffe/d393/f151/0923/af16/slideshow/urban-regeneration-4-projects-harnessing-water-to-reconnect-cities-with-nature_1.jpg?1725251594') no-repeat center center fixed; background-size: cover; margin: 0; padding: 20px; color: #333; display: flex; flex-direction: column; align-items: center; text-align: center; }
    .container { background-color: rgba(255, 255, 255, 0.97); padding: 25px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.15); width: 90%; max-width: 700px; margin-top: 20px; }
    #timer { position: fixed; top: 15px; right: 15px; font-size: 2em; font-weight: bold; color: white; background-color: rgba(0, 0, 0, 0.7); padding: 8px 16px; border-radius: 8px; }
    button { background-color: #4CAF50; color: white; border: none; border-radius: 8px; padding: 12px 20px; cursor: pointer; font-size: 16px; font-weight: bold; transition: all 0.2s ease-in-out; margin: 10px 5px; }
    button:hover:not(:disabled) { background-color: #45a049; transform: translateY(-2px); }
    button:disabled { background-color: #a5d6a7; cursor: not-allowed; }
    input[type="text"], input[type="number"] { border: 2px solid #ccc; border-radius: 8px; font-size: 18px; padding: 10px; text-align: center; width: 80%; margin: 10px auto; display: block; }
    input:focus { border-color: #4CAF50; outline: none; }
    ul { list-style-type: none; padding: 0; }
    li { background-color: #f0f0f0; margin: 5px 0; padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
    li.active-player { background-color: #A5D6A7; font-weight: bold; }
    #questionPlaceholder { font-size: 2.5em; letter-spacing: 0.4em; font-family: 'Courier New', Courier, monospace; font-weight: bold; margin: 20px 0; color: #d32f2f; }
    #spectatorGuess { font-style: italic; color: #555; height: 24px; margin-top: 15px; }
    .hidden { display: none; }
  </style>
</head>
<body>

  <div id="startScreen" class="container">
    <h1>Ekolojik Kelime Oyunu</h1>
    <label for="playerNameInput">ƒ∞sminiz:</label>
    <input type="text" id="playerNameInput" placeholder="ƒ∞sminizi girin" />
    <label for="playerCountInput">Maksimum Oyuncu Sayƒ±sƒ± (2-5):</label>
    <input type="number" id="playerCountInput" min="2" max="5" value="2" />
    <label for="roomCodeInput">Oda Kodu (katƒ±lmak i√ßin):</label>
    <input type="text" id="roomCodeInput" placeholder="Oda kodu gir veya bo≈ü bƒ±rak" maxlength="6" />
    <button id="btnEnterRoom">Odaya Katƒ±l / Kur</button>
  </div>
  
  <div id="lobbyScreen" class="container hidden">
      <h2>Oyun Lobisi</h2>
      <p>Bu kodu arkada≈ülarƒ±nla payla≈ü: <strong id="lobbyRoomCode"></strong></p>
      <h3>Oyuncular (<span id="lobbyPlayerCount"></span>/<span id="lobbyMaxPlayers"></span>)</h3>
      <ul id="lobbyPlayerList"></ul>
      <button id="btnForceStart" class="hidden">Oyunu Ba≈ülat</button>
      <p id="lobbyWaitingText">Oda y√∂neticisinin oyunu ba≈ülatmasƒ± bekleniyor...</p>
  </div>

  <div id="gameArea" class="container hidden">
      <div id="timer">3:00</div>
      <h3 id="activePlayerName"></h3>
      <p><b id="questionCounter"></b> (<span id="questionWordLength"></span> Harfli)</p>
      <i id="questionDefinition"></i>
      <div id="questionPlaceholder"></div>
      <input type="text" id="answerInput" placeholder="Tahminini yaz" autocomplete="off">
      <p id="spectatorGuess"></p>
      <button id="btnSubmitAnswer">G√∂nder</button>
      <button id="btnRevealLetter">Harf Al (-100 Puan)</button>
      <hr>
      <h3>Skor Tablosu</h3>
      <ul id="scoreboardList"></ul>
  </div>

  <div id="endGameScreen" class="container hidden"></div>

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script>
    // --- ELEMENT REFERANSLARI ---
    const startScreen = document.getElementById('startScreen');
    const lobbyScreen = document.getElementById('lobbyScreen');
    const gameArea = document.getElementById('gameArea');
    const endGameScreen = document.getElementById('endGameScreen');
    // Diƒüer elementler fonksiyon i√ßinde se√ßilecek

    // --- FIREBASE & OYUN DEƒûƒ∞≈ûKENLERƒ∞ ---
    const firebaseConfig = { /* KENDƒ∞ CONFIG Bƒ∞LGƒ∞LERƒ∞Nƒ∞Z */ };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let myPlayerId = localStorage.getItem('myPlayerId') || db.ref().push().key;
    localStorage.setItem('myPlayerId', myPlayerId);
    let playerName = "";
    let roomCode = "";
    let roomListener = null;
    let timerInterval = null;
    const TURN_DURATION = 180;

    const kelimeler = {
        4: {"Atƒ±k": "Kullanƒ±m sonrasƒ± geriye kalan maddeler", "Azot": "Atmosferde en y√ºksek y√ºzdeyle bulunan gaz", "Hava": "Sonrasƒ±na cƒ±va getirilerek konu≈üulan konunun bo≈ü olduƒüunu belirten kelime", "Aƒüa√ß": "Orman dokusu", "Otsu": "Ot gibi olan", "Kent": "≈ûehir", "Park": "Vatanda≈ülarƒ±n dinlenme ve oyun ihtiya√ßlarƒ±nƒ± kar≈üƒ±layan alan", "Plan": "Belirlenen hedefe ula≈ümak i√ßin olu≈üturulan strateji ve yol haritasƒ±", "Oyun": "Eƒülence amacƒ±yla yapƒ±lan etkinlik", "Dere": "K√º√ß√ºk, doƒüal su yolu"},
        5: {"√áevre": "Canlƒ±larƒ±n ya≈üadƒ±ƒüƒ± ve etkile≈üimde bulunduƒüu doƒüal veya insan yapƒ±mƒ± ortam", "ƒ∞klim": "Uzun s√ºreli hava ko≈üullarƒ± ortalamasƒ±", "Liken": "Mantar ve fotosentetik organizmanƒ±n simbiyotik ili≈ükisi", "Flora": "Bir b√∂lgede bulunan bitki t√ºrlerinin toplamƒ±", "Fauna": "Bir b√∂lgede bulunan hayvan t√ºrlerinin toplamƒ±", "Deniz": "Karalarƒ± √ßevreleyen geni≈ü su k√ºtlesi", "Bah√ße": "Bitki yeti≈ütirmeye ve dinlenmeye uygun d√ºzenlenmi≈ü ye≈üil alan", "Ye≈üil": "Bir renk", "Yaban": "Vah≈üi, doƒüal", "Yunus": "Sosyal ve zeki memeli"},
        6: {"R√ºzgar": "Havanƒ±n hareketiyle olu≈üan doƒüal akƒ±m", "Toprak": "Bitkilerin yeti≈ütiƒüi ve canlƒ±larƒ±n barƒ±ndƒ±ƒüƒ± doƒüal zemin", "Peyzaj": "Fransƒ±zca kƒ±r manzarasƒ±", "Enerji": "Hareketi meydana getiren temel g√º√ß", "Deprem": "Yer kabuƒüunun sarsƒ±lmasƒ±", "YAYSƒ∞S": "Ye≈üil alan y√∂netim sistemi kƒ±saltmasƒ±", "Payda≈ü": "Bir projenin etkilenen birey veya grubu", "Diren√ß": "Dƒ±≈ü etkilere kar≈üƒ± g√∂sterilen tepki", "Heykel": "Ta≈ü, metal veya ah≈üaptan yapƒ±lan sanat eseri", "Takson": "Canlƒ±larƒ±n gruplandƒ±rƒ±lma birimi"},
        7: {"Ekoloji": "Canlƒ±larƒ±n √ßevreleriyle ili≈ükisini inceleyen bilim", "D√∂n√º≈ü√ºm": "Kafka'nƒ±n bilinen eseri", "Tasarƒ±m": "Estetik ve i≈ülevsel planlama s√ºreci", "Habitat": "Canlƒ±larƒ±n doƒüal ya≈üam alanƒ±", "Erozyon": "Topraƒüƒ±n su veya r√ºzgarla a≈üƒ±nƒ±p ta≈üƒ±nmasƒ±", "Organik": "Sentetik olmayan", "Ekosfer": "T√ºm ekosistemleri kapsayan kavram", "Biyolog": "Canlƒ±larƒ± inceleyen bilim insanƒ±", "Kreatif": "Yaratƒ±cƒ± d√º≈ü√ºnce yeteneƒüi", "Ku≈üg√∂√ß√º": "Kanatlƒ± hayvan hicreti"},
        8: {"Kurak√ßƒ±l": "Az su isteyen", "Strateji": "Belirli hedefe ula≈üma planƒ±", "Kirlilik": "ƒ∞stenmeyen maddelerin varlƒ±ƒüƒ±", "ƒ∞stanbul": "Metropol", "Ekolojik": "√áevre bilimiyle ilgili", "√áalƒ±≈ütay": "Belli bir konuda, √ße≈üitli konu≈ümacƒ±larƒ±n katƒ±lƒ±mƒ±yla d√ºzenlenen, bilimsel aƒüƒ±rlƒ±klƒ± toplantƒ±", "Atmosfer": "Hava tabakasƒ±", "Biyoloji": "Canlƒ±larƒ± ve ya≈üam s√ºre√ßlerini inceleyen bilim dalƒ±", "M√ºhendis": "Arap√ßa hendese kelimesinden t√ºreyen kelime; √∂l√ß√ºm yapan, hesaplayan", "Anƒ±taƒüa√ß": "Ya≈üƒ±, tarihi veya doƒüal √∂zellikleriyle koruma altƒ±na alƒ±nmƒ±≈ü olan"},
        9: {"Ekosistem": "Canlƒ±lar ve √ßevre arasƒ±ndaki etkile≈üim", "K√ºt√ºphane": "Bilgi kaynaklarƒ±nƒ±n saklandƒ±ƒüƒ± ve okuyuculara sunulduƒüu yer", "B√ºy√ºkdere": "Atat√ºrk‚Äô√ºn mirasƒ±", "ƒ∞novasyon": "Yeni fikir ve √ºr√ºn geli≈ütirme s√ºreci", "Sulakalan": "Bitki ve hayvan √ße≈üitliliƒüi a√ßƒ±sƒ±ndan zengin, nemli ve verimli ekosistemlerdir", "Ye≈üil√ßatƒ±": "√áevre dostu yapƒ± tasarƒ±mƒ±", "Amenajman": "Ormanlarƒ±n s√ºrd√ºr√ºlebilir kullanƒ±mƒ± ve verimli y√∂netimi i√ßin planlama yapan ormancƒ±lƒ±k alanƒ±", "Departman": "Kurulu≈ü i√ßi b√∂l√ºm", "Herbaryum": "Kurutulmu≈ü bitki koleksiyonu", "Sƒ±fƒ±ratƒ±k": "Hammadelerin d√∂n√º≈ü√ºm√º √ºzerine kurulan sistem"},
        10: {"Rekreasyon": "Bo≈ü zaman aktiviteleri", "Doƒüal√ßevre": "Yapƒ±lƒ± olmayan, m√ºdahale g√∂rmemi≈ü", "Fotosentez": "Bitkilerin g√ºne≈ü enerjisiyle besin √ºretme s√ºreci", "Adaptasyon": "Canlƒ±larƒ±n ya≈üadƒ±klarƒ± √ßevreye uyum saƒülamak i√ßin geli≈ütirdiƒüi kalƒ±tsal veya fizyolojik √∂zellikler", "Kentormanƒ±": "Kentsel ekosistemin par√ßasƒ± olan, ye≈üil doku ve biyo√ße≈üitliliƒüi barƒ±ndƒ±ran alanlar", "Korumazonu": "Ekosistemleri ve biyolojik √ße≈üitliliƒüi korumak amacƒ±yla belirlenen √∂zel alan", "Vejetasyon": "Doƒüal bitki √∂rt√ºs√º", "Likenoloji": "Mantar ve alglarƒ±n incelenmesi", "Ye≈üilku≈üak": "≈ûehirleri √ßevreleyen, ekolojik dengeyi koruyan aƒüa√ßlƒ±k ve doƒüal alanlar", "B√ºy√ºk≈üehir": "Geli≈ümi≈ü sosyal ve altyapƒ±lƒ± ≈üehir"}
    };
    const points = { 4: 400, 5: 500, 6: 600, 7: 700, 8: 800, 9: 900, 10: 1000 };

    // --- ODA Y√ñNETƒ∞Mƒ∞ ---
    document.getElementById("btnEnterRoom").onclick = async () => {
      playerName = document.getElementById("playerNameInput").value.trim();
      if (!playerName) { alert("L√ºtfen isminizi girin!"); return; }
      
      let enteredCode = document.getElementById("roomCodeInput").value.trim().toUpperCase();

      if (enteredCode) await joinRoom(enteredCode);
      else await createRoom();
    };

    async function createRoom() {
        roomCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        const maxPlayers = parseInt(document.getElementById("playerCountInput").value);
        const roomData = {
            hostId: myPlayerId,
            maxPlayers: maxPlayers,
            status: "waiting",
            players: { [myPlayerId]: { name: playerName, score: 0 } }
        };
        await db.ref(`rooms/${roomCode}`).set(roomData);
        setupListenerAndPresence();
    }

    async function joinRoom(code) {
        const roomRef = db.ref(`rooms/${code}`);
        const snapshot = await roomRef.get();
        if (!snapshot.exists()) { alert("Oda bulunamadƒ±."); return; }
        
        const roomData = snapshot.val();
        if (roomData.status !== 'waiting') {
            alert("Bu oyun ya ba≈ülamƒ±≈ü ya da bitmi≈ü."); return;
        }
        if (Object.keys(roomData.players || {}).length >= roomData.maxPlayers) {
            alert("Oda dolu."); return;
        }
        
        roomCode = code;
        await db.ref(`rooms/${roomCode}/players/${myPlayerId}`).set({ name: playerName, score: 0 });
        setupListenerAndPresence();
    }
    
    function setupListenerAndPresence() {
        db.ref(`rooms/${roomCode}/players/${myPlayerId}`).onDisconnect().remove();
        
        if (roomListener) db.ref(`rooms/${roomCode}`).off("value", roomListener);
        
        roomListener = db.ref(`rooms/${roomCode}`).on("value", (snapshot) => {
            if (!snapshot.exists()) {
                alert("Oda kapatƒ±ldƒ±.");
                window.location.reload();
                return;
            }
            routeUI(snapshot.val());
        });
    }

    // --- ARAY√úZ Y√ñNLENDƒ∞RME & G√úNCELLEME ---
    
    function routeUI(data){
        startScreen.classList.add('hidden');
        lobbyScreen.classList.add('hidden');
        gameArea.classList.add('hidden');
        endGameScreen.classList.add('hidden');

        if (data.status === 'waiting') {
            lobbyScreen.classList.remove('hidden');
            updateLobbyUI(data);
        } else if (data.status === 'playing') {
            gameArea.classList.remove('hidden');
            updateGameUI(data);
        } else if (data.status === 'finished') {
            endGameScreen.classList.remove('hidden');
            updateEndGameUI(data);
        }
    }

    function updateLobbyUI(data) {
        const players = data.players || {};
        const isHost = data.hostId === myPlayerId;

        document.getElementById('lobbyRoomCode').textContent = roomCode;
        document.getElementById('lobbyPlayerCount').textContent = Object.keys(players).length;
        document.getElementById('lobbyMaxPlayers').textContent = data.maxPlayers;
        
        const playerList = document.getElementById('lobbyPlayerList');
        playerList.innerHTML = Object.values(players).map(p => `<li>${p.name}</li>`).join('');
        
        const startButton = document.getElementById('btnForceStart');
        const waitingText = document.getElementById('lobbyWaitingText');
        
        if (isHost) {
            startButton.classList.remove('hidden');
            waitingText.classList.add('hidden');
            startButton.disabled = Object.keys(players).length < 2;
            startButton.onclick = () => startGame();
        } else {
            startButton.classList.add('hidden');
            waitingText.classList.remove('hidden');
        }
    }

    function updateGameUI(data) {
        const turn = data.turn;
        if (!turn) return;

        const activePlayerId = data.playerOrder[data.turnIndex];
        const activePlayer = data.players[activePlayerId];
        const isMyTurn = myPlayerId === activePlayerId;
        const currentQuestion = turn.questions[turn.questionIndex];

        if (!currentQuestion) {
             if (isMyTurn) nextPlayerTurn();
             return;
        }

        // Aray√ºz√º g√ºncelle (innerHTML yok!)
        document.getElementById('activePlayerName').textContent = `Sƒ±radaki Oyuncu: ${activePlayer.name}`;
        document.getElementById('questionCounter').textContent = `Soru ${turn.questionIndex + 1}/${turn.questions.length}`;
        document.getElementById('questionWordLength').textContent = currentQuestion.word.length;
        document.getElementById('questionDefinition').textContent = currentQuestion.definition;
        
        let placeholder = currentQuestion.word.split('').map((char, i) => (turn.revealedLetters || [])[i] ? char : '_').join('');
        document.getElementById('questionPlaceholder').textContent = placeholder;

        const answerInput = document.getElementById('answerInput');
        answerInput.disabled = !isMyTurn;
        
        const spectatorGuess = document.getElementById('spectatorGuess');
        spectatorGuess.textContent = '';

        if (isMyTurn) {
            answerInput.value = '';
            answerInput.focus();
            answerInput.oninput = e => db.ref(`rooms/${roomCode}/turn/guess`).set(e.target.value);
        } else {
            answerInput.value = turn.guess || '';
            if (turn.guess) {
                 spectatorGuess.innerHTML = `<b>${activePlayer.name} yazƒ±yor:</b> ${turn.guess}`;
            }
        }

        document.getElementById('btnSubmitAnswer').disabled = !isMyTurn;
        document.getElementById('btnRevealLetter').disabled = !isMyTurn;

        document.getElementById('scoreboardList').innerHTML = data.playerOrder
            .map(pid => {
                if (!data.players[pid]) return '';
                const activeClass = pid === activePlayerId ? 'active-player' : '';
                return `<li class="${activeClass}"><span>${data.players[pid].name}</span> <span>${data.players[pid].score} Puan</span></li>`
            }).join('');
        
        startTimer(turn.startTime);
    }
    
    function updateEndGameUI(data) {
        stopTimer();
        const players = Object.values(data.players || {}).sort((a,b) => b.score - a.score);
        let html = `
            <h2>Oyun Bitti!</h2>
            <h3>Kazanan: ${players.length > 0 ? players[0].name : ''} üèÜ</h3>
            <ul>
                ${players.map((p, i) => `<li><span>${i+1}. ${p.name}</span> <span>${p.score} Puan</span></li>`).join('')}
            </ul>
            <button onclick="window.location.reload()">Yeni Oyun</button>
        `;
        endGameScreen.innerHTML = html;
        setTimeout(() => db.ref(`rooms/${roomCode}`).remove(), 30000);
    }


    // --- OYUN AKI≈ûI FONKSƒ∞YONLARI ---

    function generateQuestions() {
        const questions = [];
        for (let len = 4; len <= 10; len++) {
            const words = Object.keys(kelimeler[len] || {}).sort(() => 0.5 - Math.random());
            for(let i=0; i < 2 && i < words.length; i++){
                 questions.push({ word: words[i], definition: kelimeler[len][words[i]] });
            }
        }
        return questions.sort(() => 0.5 - Math.random());
    }

    async function startGame() {
        const roomData = (await db.ref(`rooms/${roomCode}`).get()).val();
        const playerIds = Object.keys(roomData.players).sort(() => 0.5 - Math.random());
        
        await db.ref(`rooms/${roomCode}`).update({
            status: 'playing',
            playerOrder: playerIds,
            turnIndex: 0,
            turn: {
                playerId: playerIds[0],
                questions: generateQuestions(),
                questionIndex: 0,
                revealedLetters: [],
                guess: "",
                startTime: firebase.database.ServerValue.TIMESTAMP
            }
        });
    }

    document.getElementById('btnSubmitAnswer').onclick = async () => {
        const roomData = (await db.ref(`rooms/${roomCode}`).get()).val();
        const correctWord = roomData.turn.questions[roomData.turn.questionIndex].word;
        const guess = document.getElementById("answerInput").value.trim().toUpperCase();
        if (!guess) return;

        let scoreChange = (guess === correctWord.toUpperCase()) ? (points[correctWord.length] || 0) : -200;
        
        await db.ref(`rooms/${roomCode}/players/${myPlayerId}/score`).set(firebase.database.ServerValue.increment(scoreChange));
        await moveToNextQuestion();
    };
    
    async function moveToNextQuestion() {
        const turnRef = db.ref(`rooms/${roomCode}/turn`);
        const turnData = (await turnRef.get()).val();

        if (turnData.questionIndex + 1 >= turnData.questions.length) {
            await nextPlayerTurn();
        } else {
            await turnRef.update({
                questionIndex: firebase.database.ServerValue.increment(1),
                revealedLetters: [],
                guess: ""
            });
        }
    }

    async function nextPlayerTurn() {
        stopTimer();
        const roomData = (await db.ref(`rooms/${roomCode}`).get()).val();
        if (!roomData || !roomData.playerOrder) return;

        const newTurnIndex = roomData.turnIndex + 1;

        if (newTurnIndex >= roomData.playerOrder.length) {
            await db.ref(`rooms/${roomCode}`).update({ status: 'finished' });
        } else {
            const nextPlayerId = roomData.playerOrder[newTurnIndex];
            await db.ref(`rooms/${roomCode}`).update({
                turnIndex: newTurnIndex,
                turn: {
                    playerId: nextPlayerId,
                    questions: generateQuestions(),
                    questionIndex: 0,
                    revealedLetters: [],
                    guess: "",
                    startTime: firebase.database.ServerValue.TIMESTAMP
                }
            });
        }
    }
    
    document.getElementById('btnRevealLetter').onclick = async () => {
        const turnRef = db.ref(`rooms/${roomCode}/turn`);
        const turnData = (await turnRef.get()).val();
        const word = turnData.questions[turnData.questionIndex].word;
        
        let revealed = turnData.revealedLetters || [];
        const unrevealedIndexes = [];
        for(let i = 0; i < word.length; i++) {
            if(!revealed[i]) unrevealedIndexes.push(i);
        }

        if(unrevealedIndexes.length > 0) {
            const randomIndex = unrevealedIndexes[Math.floor(Math.random() * unrevealedIndexes.length)];
            revealed[randomIndex] = true;
            
            await db.ref(`rooms/${roomCode}/players/${myPlayerId}/score`).set(firebase.database.ServerValue.increment(-100));
            await turnRef.update({ revealedLetters: revealed });
        }
    };
    
    // --- ZAMANLAYICI ---
    function startTimer(startTime) {
        stopTimer();
        const timerEl = document.getElementById('timer');
        timerInterval = setInterval(async () => {
            const elapsed = Math.floor((Date.now() - startTime) / 1000);
            let timeRemaining = TURN_DURATION - elapsed;
            
            if (timeRemaining <= 0) {
                timeRemaining = 0;
                stopTimer();
                const roomData = (await db.ref(`rooms/${roomCode}`).get()).val();
                if(roomData && roomData.playerOrder && myPlayerId === roomData.playerOrder[roomData.turnIndex]){
                    nextPlayerTurn();
                }
            }
            const m = Math.floor(timeRemaining / 60);
            const s = timeRemaining % 60;
            timerEl.textContent = `${m}:${s < 10 ? "0" + s : s}`;
        }, 1000);
    }
    function stopTimer() { if (timerInterval) clearInterval(timerInterval); timerInterval = null; }
  </script>
</body>
</html>
